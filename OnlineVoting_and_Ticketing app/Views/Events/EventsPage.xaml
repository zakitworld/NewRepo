<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
             x:Class="OnlineVoting_and_Ticketing_app.Views.Events.EventsPage"
             Title="Discover Events"
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,*">
        <!-- Background Glow -->
        <Ellipse Grid.RowSpan="2" WidthRequest="300" HeightRequest="300" 
                  Fill="{StaticResource Primary}" Opacity="0.03" 
                  VerticalOptions="Start" HorizontalOptions="End" Margin="0,-100,-100,0"/>

        <!-- Header Section -->
        <VerticalStackLayout Grid.Row="0" Padding="25" Spacing="20">
            <Label Text="Explore Events" Style="{StaticResource Headline}" TextColor="{StaticResource White}"/>
            
            <!-- Search Bar -->
            <Border Style="{StaticResource Border}" Padding="15,2" HeightRequest="50">
                <Grid ColumnDefinitions="Auto,*">
                    <Label Text="ðŸ”" VerticalOptions="Center" Margin="0,0,10,0" Opacity="0.5"/>
                    <Entry x:Name="SearchEntry" Grid.Column="1" Placeholder="Search events..." 
                           PlaceholderColor="{StaticResource TextSecondary}" TextColor="{StaticResource White}"
                           FontSize="14" VerticalOptions="Center" TextChanged="OnSearchTextChanged"/>
                </Grid>
            </Border>

            <!-- Categories -->
            <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                <HorizontalStackLayout Spacing="10">
                    <Border x:Name="AllCategoryButton" StrokeThickness="0" StrokeShape="RoundRectangle 25" 
                            BackgroundColor="{StaticResource Primary}" Padding="20,10">
                        <Label Text="All" TextColor="White" FontSize="13" FontAttributes="Bold"/>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCategoryTapped" CommandParameter="All" />
                        </Border.GestureRecognizers>
                    </Border>
                    
                    <Border Style="{StaticResource Border}" StrokeShape="RoundRectangle 25" Padding="20,10">
                        <Label Text="Music" TextColor="{StaticResource White}" FontSize="13"/>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCategoryTapped" CommandParameter="Music" />
                        </Border.GestureRecognizers>
                    </Border>

                    <Border Style="{StaticResource Border}" StrokeShape="RoundRectangle 25" Padding="20,10">
                        <Label Text="Sports" TextColor="{StaticResource White}" FontSize="13"/>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCategoryTapped" CommandParameter="Sports" />
                        </Border.GestureRecognizers>
                    </Border>

                    <Border Style="{StaticResource Border}" StrokeShape="RoundRectangle 25" Padding="20,10">
                        <Label Text="Conference" TextColor="{StaticResource White}" FontSize="13"/>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnCategoryTapped" CommandParameter="Conference" />
                        </Border.GestureRecognizers>
                    </Border>
                </HorizontalStackLayout>
            </ScrollView>
        </VerticalStackLayout>

        <!-- Main Content -->
        <RefreshView Grid.Row="1" x:Name="RefreshView" Refreshing="OnRefreshing" RefreshColor="{StaticResource Primary}">
            <CollectionView x:Name="EventsCollectionView" SelectionMode="Single" SelectionChanged="OnEventSelected" Margin="20,0">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="25" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource Border}" Padding="0">
                            <Grid RowDefinitions="180,Auto">
                                <!-- Image with Gradient Overlay -->
                                <Grid Grid.Row="0">
                                    <ffimageloading:CachedImage Source="{Binding ImageUrl}" Aspect="AspectFill" />
                                    <Rectangle Fill="{StaticResource Background}" Opacity="0.2"/>
                                    <Border HorizontalOptions="End" VerticalOptions="Top" Margin="15" 
                                            Padding="10,5" StrokeShape="RoundRectangle 8" Background="#CC16161A" StrokeThickness="0">
                                        <Label Text="{Binding Category, Converter={StaticResource UpperCaseConverter}}" 
                                               TextColor="{StaticResource Primary}" FontSize="9" FontAttributes="Bold" CharacterSpacing="1"/>
                                    </Border>
                                </Grid>

                                <!-- Details -->
                                <VerticalStackLayout Grid.Row="1" Padding="20" Spacing="12">
                                    <Label Text="{Binding Title}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource White}"/>
                                    
                                    <HorizontalStackLayout Spacing="20">
                                        <HorizontalStackLayout Spacing="6">
                                            <Label Text="ðŸ“…" FontSize="12" VerticalOptions="Center" Opacity="0.7"/>
                                            <Label Text="{Binding StartDate, StringFormat='{0:ddd, MMM dd}'}" 
                                                   TextColor="{StaticResource TextSecondary}" FontSize="12"/>
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Spacing="6">
                                            <Label Text="ðŸ“" FontSize="12" VerticalOptions="Center" Opacity="0.7"/>
                                            <Label Text="{Binding Location}" 
                                                   TextColor="{StaticResource TextSecondary}" FontSize="12" LineBreakMode="TailTruncation"/>
                                        </HorizontalStackLayout>
                                    </HorizontalStackLayout>

                                    <Grid ColumnDefinitions="*,Auto" Margin="0,5,0,0">
                                        <HorizontalStackLayout Spacing="4">
                                            <Label Text="From" FontSize="11" TextColor="{StaticResource TextSecondary}" VerticalOptions="End" Margin="0,0,0,2"/>
                                            <Label Text="{Binding TicketTypes[0].Price, StringFormat='GHâ‚µ {0:N0}'}" 
                                                   TextColor="{StaticResource Primary}" FontSize="18" FontAttributes="Bold"/>
                                        </HorizontalStackLayout>
                                        <Label Grid.Column="1" Text="View Details â†’" TextColor="{StaticResource Secondary}" 
                                               FontSize="12" VerticalOptions="Center" FontAttributes="Bold"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="25" Padding="40" Margin="0,50,0,0">
                        <Border WidthRequest="100" HeightRequest="100" StrokeShape="RoundRectangle 50" BackgroundColor="{StaticResource Surface}" Stroke="{StaticResource GlassBorderBrush}">
                            <Label Text="âœ¨" FontSize="40" HorizontalOptions="Center" VerticalOptions="Center" Opacity="0.5"/>
                        </Border>
                        <VerticalStackLayout Spacing="8" HorizontalOptions="Center">
                            <Label Text="No Events Found" Style="{StaticResource Headline}" FontSize="20" HorizontalOptions="Center" TextColor="{StaticResource White}"/>
                            <Label Text="Be the first to create history." FontSize="14" TextColor="{StaticResource TextSecondary}" HorizontalOptions="Center"/>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Floating Action Button -->
        <Border Grid.Row="1" StrokeShape="RoundRectangle 28" StrokeThickness="0" 
                BackgroundColor="{StaticResource Primary}" WidthRequest="56" HeightRequest="56" 
                HorizontalOptions="End" VerticalOptions="End" Margin="25" Shadow="{StaticResource PrimaryShadow}">
            <Label Text="+" FontSize="30" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center"/>
            <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnCreateEventTapped" />
            </Border.GestureRecognizers>
        </Border>

        <ActivityIndicator Grid.Row="1" x:Name="LoadingIndicator" IsRunning="False" IsVisible="False" Color="{StaticResource Primary}" VerticalOptions="Center" HorizontalOptions="Center"/>
    </Grid>
</ContentPage>
